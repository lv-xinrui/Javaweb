<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.javaweb01.mapper.GradeMapper">

    <!-- 成绩结果映射 -->
    <resultMap id="GradeResultMap" type="com.example.javaweb01.entity.Grade">
        <id column="id" property="id"/>
        <result column="student_id" property="studentId"/>
        <result column="course_id" property="courseId"/>
        <result column="semester" property="semester"/>
        <result column="score" property="score"/>
        <result column="grade_point" property="gradePoint"/>
        <result column="grade_level" property="gradeLevel"/>
        <result column="exam_type" property="examType"/>
        <result column="exam_date" property="examDate"/>
        <result column="status" property="status"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        
        <!-- 关联的课程信息 -->
        <association property="course" javaType="com.example.javaweb01.entity.Course">
            <id column="course_id" property="id"/>
            <result column="course_code" property="courseCode"/>
            <result column="course_name" property="courseName"/>
            <result column="credits" property="credits"/>
            <result column="course_type" property="courseType"/>
            <result column="teacher_name" property="teacherName"/>
        </association>
    </resultMap>

    <!-- 根据学号查询所有成绩 -->
    <select id="findByStudentId" resultMap="GradeResultMap">
        SELECT g.*, c.course_code, c.course_name, c.credits, c.course_type, c.teacher_name
        FROM grades g
        LEFT JOIN courses c ON g.course_id = c.id
        WHERE g.student_id = #{studentId} AND g.status = 1
        ORDER BY g.semester DESC, g.exam_date DESC
    </select>

    <!-- 根据学号和学期查询成绩 -->
    <select id="findByStudentIdAndSemester" resultMap="GradeResultMap">
        SELECT g.*, c.course_code, c.course_name, c.credits, c.course_type, c.teacher_name
        FROM grades g
        LEFT JOIN courses c ON g.course_id = c.id
        WHERE g.student_id = #{studentId} AND g.semester = #{semester} AND g.status = 1
        ORDER BY g.exam_date DESC
    </select>

    <!-- 根据学号查询当前学期成绩 -->
    <select id="findCurrentSemesterByStudentId" resultMap="GradeResultMap">
        SELECT g.*, c.course_code, c.course_name, c.credits, c.course_type, c.teacher_name
        FROM grades g
        LEFT JOIN courses c ON g.course_id = c.id
        WHERE g.student_id = #{studentId} 
        AND g.semester = (
            SELECT MAX(semester) FROM grades WHERE student_id = #{studentId}
        )
        AND g.status = 1
        ORDER BY g.exam_date DESC
    </select>

    <!-- 根据学号统计成绩信息 -->
    <select id="findGradeStatisticsByStudentId" resultMap="GradeResultMap">
        SELECT 
            #{studentId} as student_id,
            COUNT(*) as total_courses,
            AVG(score) as avg_score,
            AVG(grade_point) as avg_grade_point,
            SUM(credits) as total_credits
        FROM grades g
        LEFT JOIN courses c ON g.course_id = c.id
        WHERE g.student_id = #{studentId} AND g.status = 1
    </select>

    <!-- 插入成绩 -->
    <insert id="insert" parameterType="com.example.javaweb01.entity.Grade" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO grades (student_id, course_id, semester, score, grade_point, grade_level, exam_type, exam_date, status, create_time)
        VALUES (#{studentId}, #{courseId}, #{semester}, #{score}, #{gradePoint}, #{gradeLevel}, #{examType}, #{examDate}, #{status}, #{createTime})
    </insert>

</mapper>
